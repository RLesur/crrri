---
title: "How crrri can be used"
author: "C. Dervieux"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How crrri can be used}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = TRUE,
  comment = "#>"
)

Sys.unsetenv("DEBUGME")
```

```{r knit-print-promise, include=FALSE}
await <- function(promise) {
  state <- new.env()
  state$pending <- TRUE
  
  promises::then(
    promise,
    onFulfilled = function(value) {
      state$pending <- FALSE
      state$fulfilled <- TRUE
      state$value <- value
    },
    onRejected = function(error) {
      state$pending <- FALSE
      state$fulfilled <- FALSE
      state$reason <- error
    }
  )
  
  while(state$pending) {
    later::run_now()
  }
  
  if (state$fulfilled) {
    return(state$value)
  } else {
    stop(state$reason)
  }
}

knit_print.promise <- function(x, ...) {
  knitr::knit_print(await(x))
}
```

This vignette aims to show several examples of usage for `crrri`.

All the examples are inspired from examples for the _chrome remote interface_ or _puppeteer_ libraries and show how to reproduce those using `crrri`.

# Setup

To work with `crrri`, you need to load it. We also have set up beforehand `Sys.getenv("CHROME_BIN")` to a chrome binary on our system. If you don't, you'll need to provide the path to a chrome binary in `chr_connect`.

We need to load `crrri` and also `promises` to have the tools to deals with
_promises_ that `crrri` is based on.

```{r}
library(crrri)
library(promises)
```

# Example 1. Take a screenshot

Inspired from this
[post](https://jonathanmh.com/taking-full-page-screenshots-headless-chrome/) and
use _chrome remote interface_

```{r chome-snapshot}
targetUrl <- "https://cran.rstudio.com"
viewport <- c(1440, 900)
screenshotDelay <- 2 # seconds
screenshot_file <- tempfile(fileext = ".png")

chrome_con <- chr_connect()

screenshot <-
  chrome_con %>%
  # Enable Events on Domains
  Page.enable() %>%
  DOM.enable() %>%
  Network.enable() %>%
  Emulation.setDeviceMetricsOverride(
    width = viewport[1],
    height = viewport[2],
    deviceScaleFactor = 0,
    mobile = FALSE,
    dontSetVisibleSize = FALSE
  ) %>%
  # Go to url
  Page.navigate(targetUrl) %>%
  Page.loadEventFired() %>%
  # add a delay 
  wait(delay = screenshotDelay) %>%
  # Capture screenshot
  Page.captureScreenshot(format = "png", fromSurface = TRUE) %...>% 
  {
    .$result$data %>% jsonlite::base64_dec() %>% writeBin(screenshot_file)
  } #%>%
  # Close the chrome connexion
  #finally(~ chr_disconnect(chrome_con)) %...!% {
  #  cat("Global error\n", .$message)
  #}
```

```{r}
# await screenshot
await(screenshot)
#await(chr_disconnect(chrome_con))
# I think chr_disconnect has a bug
```

The snapshot is written to disk and looks like this:
```{r}
img <- magick::image_read(screenshot_file)
magick::image_scale(img, "400")
```

# Example 2. Dump HTML after page loaded

Inspired from this [JS script](https://github.com/cyrus-and/chrome-remote-interface/wiki/Dump-HTML-after-page-load) for _chrome remote interface_ wiki that dumps the DOM.

```{r, eval=TRUE}
#chrome <- chr_connect()
html_file <- tempfile(fileext = ".html")

dump_dom <- 
  chrome_con %>%
  Network.enable() %>%
  Page.enable() %>%
  Network.setCacheDisabled(cacheDisabled = TRUE) %>%
  Page.navigate(url = "https://github.com", awaitResult = FALSE) %>% # because the following event listener does not use this result, it is safer to use awaitResult = FALSE
  Page.loadEventFired() %>%
  Runtime.evaluate(expression = 'document.documentElement.outerHTML') %...>% {
   writeLines(c(.$result$result$value, "\n"), con = html_file) 
  } #%>%
  # Close the connexion when finish
  #finally(~ chr_disconnect(chrome)) %...!% {
   # cat(.$message)
  #}
```

```{r, eval=TRUE}
await(dump_dom)
await(chr_disconnect(chrome_con))
```

Here is the first 20 lines of what we get in `html_file`:

```{r, eval=TRUE,echo = FALSE, results='asis'}
cat(paste0(
  c("```html", readLines(html_file, n = 20), "```"), 
  collapse = "\n"
))
```

This could be useful to parse html with `rvest` after a page is loaded. 
